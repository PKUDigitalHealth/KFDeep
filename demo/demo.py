import pandas as pd
import numpy as np


def sigmoid(x):
    return 1 / (1 + np.exp(-x))


def tanh(x):
    return np.tanh(x)


def calibration_value(value, percentiles=None):
    if percentiles is None:
        percentiles = [0, 1.302E-07, 2.514E-07, 5.142E-07, 1.178E-06, 4.49407423123695E-06,
                       0.000007568, 0.00001336, 0.00003832, 0.000226477, 1]
    for i in range(len(percentiles) - 1):
        if value <= percentiles[i + 1]:
            mapped_value = (value - percentiles[i]) / percentiles[i + 1] * 0.1 + i * 0.1
            break
    return mapped_value


# model parameters
W_d = [[0.28823587, 0.30837104, -0.06483182, 0.18446353, -0.41348183, -0.13120103, 0.28277317, -0.13969424, -0.33177415,
        0.32751814, 0.27847645, -0.15493658, 0.27710518, 0.01180339, -0.24172369, -0.40228388],
       [0.01847243, 0.20177276, -0.12779173, -0.13620554, 0.09331599, 0.23769608, 0.1735444, 0.3187266, 0.11471838,
        0.3354946, -0.14162366, 0.36247978, 0.25758213, 0.37522638, -0.26157993, 0.14886661],
       [0.20547006, 0.0404414, -0.3420665, -0.3140768, 0.33961704, 0.3027447, -0.43473876, -0.26829627, -0.20430918,
        -0.09668789, -0.05329025, -0.34488848, -0.37376836, -0.36079064, -0.00318974, -0.09164329],
       [-0.26379463, -0.10528121, -0.22497973, -0.10388045, 0.0268186, 0.03806255, -0.10910976, -0.06839766, 0.07487645,
        -0.12022369, 0.3731221, 0.27457196, 0.17107327, 0.16381243, -0.21354738, 0.06938604],
       [-0.11655477, -0.04347307, -0.06552833, 0.09845742, -0.44809666, 0.49244583, -0.0191074, 0.20007822, -0.43548048,
        -0.29623225, -0.2637989, 0.03464369, -0.09257504, -0.29688072, 0.34579214, 0.2919662],
       [0.271921, -0.37762412, -0.02731937, 0.20116691, 0.09691261, 0.32419002, -0.280121, 0.38142112, -0.1008148,
        -0.16364855, 0.39814633, -0.31960288, 0.17393549, 0.05873964, 0.22809741, -0.02598939],
       [0.01429245, 0.18267184, 0.00087717, -0.43904138, 0.418426, 0.20163588, 0.01492826, 0.3815231, -0.2962769,
        0.08673457, -0.17660256, -0.17457382, 0.10458139, 0.41912073, 0.13026854, -0.40481663],
       [0.08823511, 0.40629566, -0.37081617, -0.19024256, -0.18305868, 0.24647495, -0.38902998, -0.22945727,
        -0.20412767, 0.2365552, -0.1599725, 0.10711227, -0.03951519, -0.29262698, -0.02472124, 0.20750986],
       [-0.2447593, 0.35180914, 0.32223073, 0.16887777, 0.07609112, 0.26029927, -0.22887526, -0.16085476, -0.14962086,
        -0.38478306, 0.38384917, 0.18347582, 0.34000507, 0.35661742, 0.00375235, -0.42075923],
       [-0.38699806, 0.06112274, -0.11652943, -0.00057147, -0.3427964, -0.01947846, 0.3772252, -0.02499445, -0.43443713,
        0.07340977, 0.06387573, 0.2290387, 0.25137234, 0.3753846, -0.38180548, 0.12142884],
       [-0.3597114, -0.2431032, -0.2597612, -0.03180506, 0.3605396, -0.2000654, 0.2511368, 0.07366727, 0.05541557,
        -0.10806579, 0.34194472, -0.39403254, 0.33837074, 0.2043292, 0.18448833, -0.04297888],
       [0.17988458, -0.2704492, -0.04570177, -0.13509569, 0.01675019, -0.3446682, 0.4430506, 0.21859008, -0.35739455,
        0.42454556, -0.08300523, 0.25990465, 0.34215555, 0.08424008, -0.31483635, -0.11976466],
       [-0.39000764, 0.01360087, -0.42334008, 0.14421713, 0.39265397, -0.10842648, -0.32399622, 0.10079353, -0.2590595,
        0.09187424, -0.20386946, -0.02251878, 0.08870061, 0.18938419, -0.36445498, -0.25606892],
       [0.28752318, 0.35674128, -0.19997996, 0.10317291, -0.05982579, -0.18303874, -0.06544431, 0.03419706, 0.26394016,
        -0.43430766, -0.3245489, -0.2206034, 0.26296505, -0.27732307, 0.13225481, 0.3534316],
       [0.18192425, -0.20429169, -0.23177451, 0.10612289, -0.19601813, -0.13547382, 0.25166976, 0.18183786, -0.33407256,
        0.4197932, -0.46571705, 0.31866315, 0.31454685, -0.4979272, 0.22561535, 0.4244345],
       [-0.13478732, 0.07748877, -0.22793931, -0.04823719, 0.3784439, -0.09038933, -0.17656186, -0.42289785, 0.04524852,
        0.28689083, -0.09897605, 0.44352987, -0.34646013, -0.28682077, 0.371783, 0.21852644]]
b_d = [3.0756582e-09, -4.7674008e-02, 1.2344599e-08, -8.6996958e-02, -1.1390066e-02, 6.4829826e-02, -3.0981699e-02,
       -2.0056766e-02, -3.3825777e-02, -6.7463316e-02, 6.3293271e-02, 6.2618144e-02, -6.4666057e-03, 8.3777778e-02,
       1.1417231e-12, 1.9038036e-02]
W_i = [[0.17907643, -0.1660072, 0.33957386, -0.20840187, -0.30982247, 0.3847878, 0.29168922, 0.45366356, 0.569455,
        0.2681641, -0.30364412, -0.07363768, 0.3862063, -0.25842732, 0.14952765, -0.36906624],
       [-0.43780386, 0.5636534, -0.50795346, -0.46558294, 0.15871195, 0.43079403, 0.1836506, 0.36004192, 0.43296692,
        -0.40789124, 0.55882305, 0.22096694, -0.13559058, 0.30754194, 0.19126518, -0.20854516],
       [0.28934997, -0.29409346, 0.18837489, 0.16637713, -0.21804798, -0.12869981, 0.36909938, -0.5210521, 0.47710335,
        -0.42391017, 0.08991638, 0.51142573, -0.28965706, -0.06632434, 0.11374082, 0.49649817],
       [-0.07737744, -0.39740983, 0.01486105, -0.01614254, 0.42741284, -0.09453441, -0.45345864, -0.12570898,
        -0.00863069, -0.54609, -0.06529832, -0.40282688, -0.32204548, 0.33056656, 0.34196374, -0.01212884],
       [-0.40211737, 0.48126948, 0.14445983, -0.02625986, 0.0718668, -0.44678834, 0.2708097, -0.5814836, -0.07638717,
        -0.4792042, -0.03508959, 0.5151148, -0.327248, 0.3122376, 0.4329573, -0.34281343],
       [-0.25235277, -0.00971162, -0.0672996, 0.01737141, -0.3798443, 0.47112224, 0.49116713, -0.38172212, -0.04686806,
        -0.40552, -0.16368389, 0.15720123, 0.04710296, 0.43866152, 0.19213504, -0.2716872]]
U_i = [[0.15879741, 0.12884352, 0.33000985, -0.33903098, -0.11516359, 0.31650224, -0.17296949, -0.17824015, -0.15624359,
        0.3408126, 0.14652368, 0.41951337, 0.09291133, 0.14394167, 0.21830365, 0.07958254],
       [0.05265832, 0.2448457, 0.28260192, 0.03379643, 0.07918417, -0.28412881, 0.41280773, 0.32275462, -0.02958668,
        0.3888056, -0.47747484, -0.03913676, 0.23489954, -0.54726464, -0.30834052, 0.18932328],
       [-0.23498352, -0.2582781, 0.35860786, -0.17066917, 0.3634413, -0.17719312, 0.28469762, 0.30524778, 0.1613551,
        -0.28115174, -0.4181934, -0.23853512, -0.13719197, -0.13664539, 0.12504241, 0.26577774],
       [-0.07647789, -0.19386524, 0.49944702, 0.08787216, 0.24387243, 0.16592133, 0.36911288, -0.24951847, 0.00304819,
        0.11797312, 0.24857527, -0.3561838, -0.03885333, -0.22470996, 0.1998257, -0.30692908],
       [0.4021499, -0.38040853, 0.19524604, -0.34743822, 0.07605888, -0.13487528, 0.16216221, 0.02747279, -0.07081537,
        0.15949638, -0.16931519, 0.17099953, -0.36099175, -0.3400317, 0.23897173, 0.24447086],
       [-0.19150038, -0.22257543, -0.14998162, -0.27251625, 0.12555473, -0.3391677, -0.26602018, 0.05409347, 0.39408588,
        -0.44012535, 0.0242855, -0.1123469, -0.33406764, 0.09993578, -0.32917523, 0.07184324],
       [-0.12798676, -0.14558583, -0.12650362, 0.15319885, 0.21824454, 0.16538508, 0.296631, 0.08394327, 0.01362837,
        0.15106122, -0.03168894, -0.3746086, 0.07390762, 0.04345079, 0.40571567, -0.4116959],
       [-0.27296457, -0.47401208, -0.20996113, 0.03207451, 0.18132007, 0.1901292, -0.2645887, -0.12355945, -0.2988221,
        -0.08488429, 0.10658348, 0.324714, 0.3398567, -0.03482237, 0.04697803, 0.4030744],
       [0.3923737, 0.2629428, -0.2017899, 0.15928902, 0.17704278, -0.21327206, 0.3230497, 0.19232148, -0.48358405,
        0.30209413, -0.36265936, 0.38144735, 0.13892086, -0.28386176, -0.17647435, -0.33393508],
       [0.40428284, -0.31048173, 0.13233715, -0.16030942, -0.19575669, -0.03034759, -0.23519728, -0.06317694,
        0.08817156, -0.13926415, -0.34579954, -0.36694315, 0.20420663, -0.39509362, 0.01032668, 0.2877343],
       [-0.2795638, -0.01506643, 0.20287585, 0.38357577, 0.32112303, 0.20869216, 0.32262674, 0.08211569, -0.37959334,
        -0.35805127, 0.31952757, 0.38581446, 0.326253, -0.33021748, 0.3116344, -0.00723541],
       [0.09261635, 0.4711364, -0.42594013, -0.16260476, 0.1777606, -0.4150599, -0.4097092, -0.07552576, 0.42639118,
        -0.00058495, 0.22601764, -0.02637593, 0.20186332, -0.11105639, -0.05354533, -0.27148253],
       [0.20243713, 0.06138436, -0.2100183, -0.05260366, 0.2642836, -0.2797119, -0.4290101, -0.29162478, 0.13640442,
        -0.29616708, -0.09018674, -0.08892311, -0.15888911, -0.05348219, 0.11421884, 0.38426402],
       [-0.16979584, 0.025593, 0.13233474, -0.3532343, 0.00233445, -0.32773986, 0.2784675, -0.12309295, 0.42096558,
        0.53865576, -0.26025754, -0.26457515, -0.16776484, 0.2131732, 0.30861676, 0.1329396],
       [-0.10329318, 0.03087994, -0.41067538, 0.1000777, -0.20359571, 0.2053739, -0.23478788, -0.09409814, -0.08884124,
        0.08063965, 0.2799945, 0.42173517, -0.16231467, -0.1537855, 0.24315527, 0.06569088],
       [-0.29005796, 0.31633338, -0.10468423, 0.0209547, 0.29176727, 0.30830398, 0.15694317, 0.41275477, -0.40562457,
        -0.1452756, -0.11893591, -0.19616964, 0.14030173, -0.16600037, -0.257064, 0.03001437]]
b_i = [1.32767131e-08, 1.13534786e-01, -8.04527476e-02, -8.59036008e-05, -7.49502853e-02, 1.74632296e-03,
       -4.44927828e-09, -6.52722269e-02, 4.72445711e-02, -1.00356042e-01, 4.45789360e-02, 1.72089636e-02,
       2.82799043e-02, 1.05810121e-01, 1.80093557e-05, -2.75927263e-08]
W_f = [[-0.45129496, -0.1480914, -0.14684227, 0.05843955, 0.32084182, 0.35751414, -0.47212592, 0.3701495, 0.3176701,
        0.34270635, -0.19724983, -0.07035474, 0.06560763, -0.4330907, -0.3583178, 0.00702733],
       [-0.27866754, -0.23958299, -0.39128798, 0.41042745, 0.39183906, -0.31262612, 0.5091604, -0.00129032, 0.1816879,
        -0.11398729, 0.35240057, 0.429677, -0.30869716, 0.16677433, -0.49935403, 0.10109539],
       [-0.01500112, -0.31353217, -0.1064496, -0.35396892, 0.16702127, -0.30576557, 0.50228006, -0.3462532, 0.06870215,
        -0.24906594, 0.10597517, 0.01988691, 0.08560038, 0.40595868, -0.377618, 0.4897707],
       [-0.15057367, 0.44182906, 0.44278324, -0.05611232, 0.10433324, 0.3055718, -0.22703955, -0.38040152, 0.4621137,
        0.4252655, 0.03415548, -0.08887444, -0.01989376, 0.4627014, -0.2170203, 0.07081544],
       [-0.20490566, -0.19598186, -0.24019295, 0.41702664, -0.3464329, 0.12669931, -0.3102906, -0.37581685, -0.44654426,
        0.44250843, 0.4694873, 0.07059711, 0.32678264, -0.00448509, -0.5049524, -0.15926296],
       [-0.38420492, 0.3697336, -0.4275412, 0.41737133, 0.01106522, -0.05384257, -0.23415026, -0.1664881, 0.48312974,
        -0.38263556, -0.0181788, 0.36876854, 0.44460922, 0.26379097, -0.30810258, 0.4881127]]
U_f = [[-0.381381, 0.23030594, -0.03870523, 0.1519768, -0.3588347, -0.39755076, -0.37348965, 0.3138533, 0.15535232,
        -0.0860025, -0.03779966, 0.29511467, -0.421398, -0.32125401, -0.1326215, 0.13979247],
       [0.18264231, -0.28311458, 0.19922581, 0.24134961, 0.3970382, 0.12320783, 0.04496095, 0.02455392, 0.17519142,
        -0.04852955, -0.19239695, 0.03085036, 0.10454175, 0.20209056, -0.13659358, -0.18015675],
       [0.01416269, -0.353991, -0.21178815, -0.38984814, 0.12903489, -0.20596106, 0.33505908, -0.12168118, -0.26245877,
        -0.36779168, 0.13155046, -0.39791375, 0.38252142, 0.00933755, -0.4148885, 0.2548023],
       [-0.12772465, 0.06995629, -0.10901842, -0.09123987, -0.03607068, 0.19205345, -0.35042945, 0.13016692, 0.03793202,
        -0.22888587, 0.07694574, -0.19974104, 0.29362407, -0.03109522, -0.36714518, -0.22518787],
       [0.29334942, -0.03985847, 0.07118514, -0.24231029, -0.03613938, 0.16772245, -0.42216003, 0.12031274, -0.23499158,
        -0.15534343, 0.24201436, 0.25737703, 0.05790582, -0.40150422, 0.25895384, 0.2687106],
       [0.04480633, 0.33162734, 0.1563702, -0.29981622, 0.06042165, 0.49871486, -0.40666863, 0.43888474, 0.15207171,
        0.3295524, 0.32559276, 0.17519166, -0.15792198, -0.39645344, -0.01604277, 0.3077485],
       [-0.0805676, -0.30248734, 0.32757935, 0.05548707, -0.25894967, -0.28875965, 0.24581817, -0.12865216, 0.3582224,
        -0.00328185, 0.45241997, -0.26900762, 0.04168228, -0.2584517, -0.26826409, 0.30077636],
       [0.19177291, -0.1191881, -0.14788795, 0.2683629, 0.07626911, -0.30807373, -0.36492825, -0.43347847, 0.04871545,
        0.30234912, -0.02861016, -0.13477157, 0.2534838, 0.23153678, 0.05504113, -0.0883855],
       [0.18864349, 0.1342326, 0.4038035, -0.1329821, -0.277365, 0.06412923, -0.14352226, -0.02012191, 0.38849542,
        -0.13321142, 0.11500674, -0.13621984, -0.27852836, 0.05550151, -0.3434794, -0.02785994],
       [0.13326177, -0.00527575, 0.4109206, 0.38374397, -0.3752253, -0.25426716, 0.21122235, 0.40877575, -0.13614589,
        -0.02452435, -0.17517371, -0.27053162, -0.18732154, 0.23649691, 0.06074885, 0.16235468],
       [0.0788177, 0.2594032, 0.08484611, -0.14692888, -0.09658644, -0.17131001, -0.25097072, -0.3524541, 0.4294688,
        0.13984849, -0.1589247, -0.42772472, 0.41103655, -0.11703499, 0.10516784, -0.06623352],
       [-0.30826575, -0.13556744, 0.1852049, 0.01730326, 0.49566546, 0.08045313, 0.13333371, 0.17489542, -0.0754911,
        0.21113698, -0.09764829, 0.14053369, 0.2777459, 0.31569055, 0.10103801, 0.22142984],
       [-0.0449951, 0.23587027, -0.22522455, -0.17043689, 0.24348968, 0.22571443, 0.16642654, -0.2453114, -0.17492864,
        0.15920928, -0.42821985, 0.04505962, 0.38882214, -0.02571367, 0.13192347, 0.35414472],
       [-0.3016367, 0.07279275, -0.4154166, 0.08939478, 0.32032833, -0.3745209, 0.13831176, -0.12993559, 0.00472435,
        0.3651889, 0.4192675, -0.4147366, -0.2425561, 0.4570357, -0.3532061, 0.06442037],
       [0.22512594, 0.07028407, 0.03245249, 0.40199915, -0.47307035, 0.08383656, -0.00682561, 0.22620156, 0.15572858,
        -0.2853864, -0.26192254, -0.27941656, 0.05434482, -0.25368184, -0.14177212, -0.07354022],
       [-0.3281368, -0.36428195, 0.00457945, 0.00551638, 0.13829955, 0.02965531, 0.3891383, -0.12686235, 0.29297665,
        0.12269506, -0.34473258, 0.13096258, 0.36477765, 0.14577791, -0.04564852, -0.1506905]]
b_f = [2.2645856e-09, 4.1679159e-02, 1.1805711e-09, 0.0000000e+00, -6.5336324e-02, 8.8539377e-02, 2.4288071e-02,
       3.6922600e-02, 5.3040325e-03, 7.9095185e-02, -1.8438842e-02, 3.1089043e-04, 2.0690041e-02, 3.6668204e-02,
       2.6273069e-11, -1.1446243e-02]
W_g = [[-0.22903454, 0.02014294, 0.29707384, -0.11127, -0.4810744, -0.20846608, 0.0340282, -0.1467799, 0.1213725,
        0.41971368, -0.10388661, 0.48282614, 0.38702792, -0.37974426, 0.45508528, -0.19572642],
       [0.24096292, -0.20399, 0.223584, 0.4935003, -0.02244898, 0.14990205, -0.12468397, 0.19422697, -0.03509682,
        0.4928673, 0.2723556, 0.06553964, 0.0263676, 0.2088914, -0.12307753, -0.25232905],
       [-0.13299447, 0.24448314, 0.37534666, 0.38745794, 0.11587656, 0.12016059, 0.22365421, -0.51489466, 0.38422444,
        0.4722259, -0.42723987, 0.15249056, 0.4487314, 0.18892778, 0.21524803, -0.08473673],
       [-0.10385233, 0.45784914, -0.45943183, -0.44226527, -0.4001301, 0.15269451, 0.14528303, -0.06995149, 0.05500535,
        0.19416475, 0.17756167, 0.11535978, 0.4508297, 0.2046396, 0.44225988, 0.02782631],
       [0.07968569, -0.2153805, 0.08000344, 0.5049234, 0.01896672, 0.14987457, -0.1752835, 0.40493417, -0.20219283,
        0.5145305, 0.084296, -0.43179464, 0.27135262, 0.02131767, 0.38678077, -0.23023662],
       [-0.06914535, -0.1320153, 0.06637454, -0.28739408, -0.36989605, 0.34319258, -0.4140072, -0.5321242, -0.5340068,
        -0.35265493, -0.4837627, 0.04584523, -0.4417753, -0.12276343, 0.12238292, 0.3645177]]
U_g = [[-0.20168933, -0.19775477, 0.41535637, -0.01211047, -0.03390262, 0.3275523, 0.24326226, 0.3407174, -0.26347154,
        -0.23585598, 0.32421872, -0.24578461, -0.30933225, 0.32875738, 0.23425117, 0.42868993],
       [-0.3660891, 0.42193958, 0.25883415, -0.12753612, 0.07965721, -0.32456076, 0.27934763, -0.19432364, 0.16916601,
        0.14213035, -0.21057032, 0.01560637, -0.3383864, -0.1542847, -0.08249897, -0.13383779],
       [-0.35410684, -0.31956193, -0.15998536, -0.17611134, 0.36276317, 0.14724843, 0.23491588, -0.346361, 0.2837987,
        0.22277948, -0.08061974, -0.03102765, -0.33770162, 0.2478061, -0.03091738, 0.36878303],
       [0.41665038, -0.37608904, 0.3278388, -0.34808466, -0.06019911, 0.20976928, 0.39297038, 0.34510437, -0.2493114,
        0.18571928, 0.1665234, 0.34800687, -0.2532358, -0.18602435, -0.21379955, -0.02819464],
       [-0.35742995, -0.03190017, -0.23705783, 0.30408046, -0.19689867, -0.38640785, -0.41719753, -0.29318282,
        -0.37291002, -0.09583768, 0.2181712, -0.03512285, 0.35245162, 0.15078487, 0.04836708, 0.14614448],
       [0.2728527, -0.35045856, -0.20685889, 0.09004477, 0.2954362, 0.25058204, 0.42035297, 0.33047196, 0.31386948,
        -0.07956719, -0.24255748, 0.02979403, 0.07203498, -0.19625044, 0.00087731, 0.3401825],
       [0.32083377, 0.06497145, -0.10316476, -0.06966788, -0.06765494, -0.14375426, -0.38576418, 0.05414481,
        -0.29359442, 0.05994412, 0.30093414, -0.41039315, 0.15173563, 0.16192205, -0.06602304, 0.28670397],
       [-0.30443656, 0.28716964, 0.2592112, 0.07633361, -0.27413508, 0.10806515, 0.31304014, -0.0633006, 0.16680616,
        0.40686306, 0.23039913, 0.17815574, 0.21263908, -0.3744293, -0.18338645, 0.41755763],
       [-0.1706425, -0.4267742, -0.32473177, -0.13269529, -0.19405036, -0.33744004, 0.24699476, 0.15340981, -0.38639942,
        -0.04130611, -0.2343292, 0.01991067, 0.08108298, 0.2980449, -0.17506766, 0.29187313],
       [-0.40697744, 0.25169638, 0.34551606, -0.12754026, -0.21489795, -0.2501851, -0.2959387, 0.20994563, -0.17884474,
        0.13952175, -0.32624394, 0.13125755, -0.35068148, 0.24981713, -0.30800873, 0.37970522],
       [-0.13646165, -0.02227706, 0.1954619, -0.23787403, -0.2923237, -0.2856122, 0.03232065, -0.05291526, -0.3824765,
        0.10357597, -0.38009864, -0.3901323, -0.16001979, 0.3749146, -0.1266337, 0.02428773],
       [-0.07101029, 0.09187989, -0.16104436, 0.01927671, -0.28156334, -0.01352364, -0.2186932, -0.13592051,
        -0.17481157, 0.25433096, 0.15080644, -0.39472696, -0.11839417, -0.23002702, 0.18141894, 0.26001748],
       [-0.36051252, 0.32923096, 0.35408816, -0.14994198, 0.13575144, 0.44805694, -0.41013527, -0.33918527, 0.14332254,
        0.07589898, 0.320879, 0.28952354, -0.25866786, -0.12686339, 0.23745771, -0.22384618],
       [-0.27108037, 0.3097315, 0.4175177, -0.18714823, -0.3250087, 0.18185285, 0.1396542, 0.10630564, -0.26002166,
        -0.07133538, 0.29911977, 0.29151767, -0.12585813, -0.3785626, 0.33564395, -0.1444343],
       [-0.09636509, -0.04588889, -0.338289, -0.29710525, -0.25239193, 0.03515349, 0.10890209, -0.46835566, -0.2516657,
        -0.27613038, 0.16082363, 0.07931449, 0.12675485, 0.32513574, 0.04618026, -0.18333754],
       [-0.03033528, -0.28666544, 0.24261233, -0.4102269, -0.03590235, -0.07607824, 0.34532192, 0.11230975, 0.10259464,
        0.18992737, 0.22940484, 0.18991712, -0.3444259, 0.37826064, -0.21060096, -0.04157215]]
b_g = [-1.2642247e-10, -4.6384530e-04, 0.0000000e+00, 6.5317880e-07, 1.1088841e-02, 8.2997225e-02, -6.2463246e-03,
       -7.1639910e-02, -4.0610638e-02, 0.0000000e+00, -9.1360537e-03, 1.5129246e-02, 4.9986813e-02, 3.9581332e-02,
       2.4455586e-02, -1.7966839e-10]
W_o = [[1.3190597e-01, 1.3688628e-01, -4.2928669e-01, 4.1605192e-01, -1.3361844e-01, -3.2879490e-01, 3.7790960e-01,
        -2.9170105e-01, 2.9563284e-01, 3.8630241e-01, 8.2389295e-02, 5.2023989e-01, 2.1528389e-01, -3.0785205e-02,
        -4.0977427e-01, -3.0238628e-01],
       [4.5646125e-01, -2.5699493e-01, 2.0141664e-01, 3.8071138e-01, 3.2580405e-01, 4.1789925e-01, 1.8783679e-02,
        5.3213704e-01, -1.6684023e-01, 4.4617811e-01, -3.9200056e-01, 3.3115107e-01, 8.1290752e-03, -9.2333987e-02,
        -1.5935463e-01, -2.7888915e-01],
       [3.7472779e-01, 9.1866046e-02, -4.6575910e-01, -4.2604384e-01, -4.7761578e-02, 1.9160151e-01, 2.3045947e-01,
        1.8365707e-02, -2.6693386e-01, 1.7527428e-01, -3.2811886e-01, 3.4905422e-01, -1.8165444e-01, 2.1949886e-01,
        4.4540921e-01, -2.7144980e-01],
       [1.8285304e-01, 2.9316027e-02, -3.2608605e-03, 5.3997636e-02, 3.1424955e-01, 4.8737547e-01, -3.7922893e-02,
        1.8812235e-01, -4.6844277e-01, 2.3526670e-01, -4.6234807e-01, 4.9283272e-01, -3.0183864e-01, 5.4986495e-01,
        -1.6979536e-01, 1.2952416e-01],
       [-4.0744036e-01, 2.3140176e-01, -2.0416230e-02, 5.0333804e-01, 2.6979542e-01, -5.4852158e-01, -1.5434809e-04,
        1.9367687e-01, 4.1074950e-01, -1.4442338e-01, -3.3274731e-01, 6.0386181e-02, 4.4721356e-01, 3.7903202e-01,
        2.1299344e-01, -4.2701930e-01],
       [4.4741696e-01, 3.1772104e-01, -3.3975890e-01, 1.4261711e-01, 2.9659727e-01, 5.0242287e-01, -2.9402927e-01,
        6.0007679e-01, -5.1179197e-02, -2.9083419e-01, -1.5891203e-01, 3.6856467e-01, -3.8393521e-01, 3.1825709e-01,
        2.9394388e-01, 5.1755682e-02]]
U_o = [[0.09416226, 0.11345163, 0.13099572, -0.3127904, 0.13334289, -0.11803561, -0.03364825, -0.01188102, 0.0075649,
        -0.1482597, 0.3419734, 0.42479655, -0.38951677, 0.28029332, 0.12771681, -0.3430793],
       [0.2994778, 0.13243897, -0.30360058, 0.05603749, 0.16682349, -0.1638421, 0.14328736, 0.18240462, -0.36179698,
        -0.08728577, 0.2246765, 0.12162033, 0.35797462, -0.26076454, 0.29379115, -0.09423343],
       [-0.24129453, -0.28915375, -0.06186265, -0.26978588, -0.1683279, 0.16782004, -0.3774902, 0.06104, 0.13988398,
        -0.01003776, 0.2545921, -0.21607393, -0.43115914, 0.41844568, 0.4275419, -0.2064894],
       [-0.21616927, -0.25792044, 0.10009692, -0.11215729, 0.08161084, 0.04039156, -0.34745172, -0.53738517,
        -0.03587186, 0.15020443, 0.12795962, -0.2600506, -0.0844788, -0.02737502, -0.05882654, 0.21674621],
       [0.27161315, -0.23647189, 0.18745242, -0.21295841, -0.00493034, 0.35361677, 0.03778067, -0.5421732, 0.28075442,
        -0.0183147, 0.28430435, 0.38913032, 0.00456744, -0.20450366, 0.4112491, -0.06317266],
       [-0.31157687, 0.26144788, 0.135016, 0.34243998, -0.21064144, 0.26614243, 0.09488384, 0.4167343, -0.33350143,
        -0.00777434, 0.3628703, -0.20108771, 0.24209338, -0.10288575, -0.26658088, -0.11768809],
       [0.355121, -0.18154116, -0.24297749, 0.11988178, -0.4585244, 0.10703871, 0.21057503, 0.13583364, 0.0944837,
        -0.36763278, 0.05323156, 0.41393486, 0.19109693, 0.15609019, 0.32772902, 0.03728195],
       [-0.03201997, 0.1719194, 0.06479813, -0.02998251, -0.24785075, -0.30062532, -0.3147935, 0.22941358, -0.05886881,
        0.06062179, 0.42685595, 0.37061182, -0.3896369, 0.01732475, -0.08876169, 0.2241097],
       [-0.15514642, 0.05227697, 0.0937615, -0.373433, -0.21000417, -0.12469899, 0.2086645, -0.3509249, 0.25013658,
        -0.21503001, 0.2848512, -0.32063603, -0.19120435, -0.20007767, -0.10148349, 0.26209363],
       [-0.28815496, 0.31337848, -0.20244546, 0.3294889, -0.02632373, -0.158206, -0.23164271, -0.27617922, 0.1206743,
        -0.17530514, -0.31488386, -0.28273252, 0.15527892, -0.40883905, 0.33429694, -0.23466688],
       [-0.05688259, -0.2410886, -0.3485563, 0.09945998, 0.13991052, -0.09304125, -0.31762597, -0.30660605, 0.14610614,
        0.08359959, -0.17507625, 0.01907369, 0.24684209, 0.38212094, 0.3126286, -0.25515795],
       [0.15735611, 0.12303016, 0.02437538, 0.36286768, -0.2242077, 0.39307773, 0.5040547, 0.2684256, 0.20719664,
        -0.38402438, 0.3607818, 0.07539406, 0.11124136, 0.41863728, -0.6036815, -0.20206718],
       [0.09504023, -0.2688919, -0.06028559, -0.43116736, 0.29085535, 0.08858738, 0.34903622, 0.2783091, 0.08714491,
        0.17748684, 0.32447365, 0.01967674, 0.09354506, 0.07191453, -0.3676395, -0.14995031],
       [-0.05258992, -0.03153688, -0.32244948, -0.315816, -0.3860276, 0.18281914, -0.21107553, -0.23613831, 0.25973672,
        -0.344359, 0.3567716, -0.26084554, -0.43876335, -0.0308325, 0.26518887, -0.31569043],
       [0.00736043, -0.39069274, 0.4010105, -0.20287678, 0.30508587, -0.26876596, 0.14062229, -0.1414771, 0.20227142,
        0.04742661, -0.39134073, -0.04385552, 0.10217255, 0.33871374, 0.12761658, -0.01122616],
       [0.32326266, -0.1294418, 0.3019441, -0.07515776, 0.30989507, 0.17891607, -0.12860315, 0.33474746, -0.08241973,
        0.23842582, -0.32085773, 0.03656065, 0.3630767, -0.3375783, 0.29319605, -0.3349433]]
b_o = [1.6364738e-13, -1.5174472e-02, 3.4930475e-02, 0.0000000e+00, 6.4748958e-02, 3.9387303e-03, -9.4649181e-02,
       1.9411898e-01, -1.3875265e-02, 5.5508424e-02, -2.3039742e-03, 0.0000000e+00, 2.0814097e-02, 1.1671669e-01,
       -7.1185045e-02, -1.7292814e-05]
weight1 = [
    [-2.21271813e-01, -7.62299867e-04, 1.70164973e-01, 8.60869288e-02, 1.51671097e-01, 2.74607185e-02, -1.54168185e-04,
     4.28714097e-01, 1.06219769e-01, 1.23937711e-01, 1.12229735e-01, -1.59338847e-01, 4.34152521e-02, 4.32312340e-02,
     -5.97143024e-02, 6.26961291e-02],
    [1.84337705e-01, 1.33623794e-01, -2.83594608e-01, 1.77417681e-01, 6.02276735e-02, -2.17717439e-01, 2.76488513e-01,
     5.91115177e-01, 2.40761116e-01, 2.46027783e-01, 1.96953624e-01, -5.51119328e-01, -4.04365778e-01, 4.43435550e-01,
     9.74915549e-02, -8.80140637e-04],
    [1.28537744e-01, -1.97708055e-01, -5.12827337e-02, 2.73708478e-02, 3.78928632e-01, -3.56753290e-01, 3.16735536e-01,
     1.85124874e-01, -6.36853045e-03, 2.95428753e-01, 6.35288358e-02, -4.21524376e-01, -2.30130047e-01, 3.19005221e-01,
     2.82242745e-01, 1.48948342e-01],
    [2.57325768e-02, 1.64003633e-02, 1.62014365e-02, -9.20318589e-02, -3.44499528e-01, 2.09460750e-01, 1.44376382e-02,
     -2.81934112e-01, -1.99005470e-01, -4.58649158e-01, -4.56268191e-02, 2.45195359e-01, 2.38146469e-01,
     -2.97268569e-01, -2.05604911e-01, 1.26703968e-02],
    [2.40075588e-01, -5.99987246e-02, -3.72764422e-03, 1.09743349e-01, -7.76631311e-02, 3.20316106e-01, -3.40385348e-01,
     -3.35620224e-01, -3.01237732e-01, -5.03285468e-01, -1.03809036e-01, 2.06323668e-01, 4.03791368e-01,
     -7.24308640e-02, -3.32521111e-01, -2.36069962e-01],
    [2.16766208e-01, 2.00418159e-01, -1.01889074e-01, -1.67505428e-01, 4.43017483e-01, -2.13166073e-01, -6.37860820e-02,
     5.30200422e-01, 3.68996948e-01, 3.12589288e-01, 1.63371608e-01, -3.58100682e-01, -3.83098125e-01, 2.32770577e-01,
     1.27582639e-01, -2.18052283e-01]]
bias1 = [0.17824435, -0.01855696, -0.20092566, 0.11554362, 0.02559275, 0.1561231]
weight2 = [[-0.18576701, -0.70863616, -0.44431958, 0.7731883, 0.5732767, -0.4949636, 0.01446323, 0.02764091],
           [0.23119858, 0.14598282, 0.46078256, -0.13976815, -0.05638299, 0.14610994, -0.15797444, -0.28893715]]
bias2 = [0.05485716, 0.31663576]
hidden_size = 16

if __name__ == '__main__':
    # raw demo data
    data = pd.read_csv('demo.csv')
    # add function1: sort
    data = data.sort_values(by = 'date', ascending = True)
    # end add function1
    # add function2: group
    data = data.groupby('date').agg(np.mean).reset_index()
    # end add function2

    # extract the static variables
    age = data['age'][0]
    gender = data['gender'][0]
    del data['age']
    del data['gender']

    # calculate the time interval between each assessment
    interval_list = [0]
    for i in range(len(data) - 1):
        interval = int(str(data['date'][i + 1])[2:4]) * 12 + int(str(data['date'][i + 1])[4:6]) - \
                   (int(str(data['date'][i])[2:4]) * 12 + int(str(data['date'][i])[4:6]))
        interval_list.append(interval)
    data['interval'] = interval_list
    del data['date']

    # filling the missing data, different for different person
    # for women
    Cr = float(110) / 88.4
    if gender == 2:
        eGFR = 144 * np.power(Cr / 0.7, -1.209) * np.power(0.993, age)
    # for men
    else:
        eGFR = 141 * np.power(Cr / 0.9, -1.209) * np.power(0.993, age)
    missing_dict = {'egfr': eGFR,
                    'albumin': 39,
                    'ca': 2,
                    'ph': 1,
                    'uacr': float(np.exp(2.4738)),
                    'hco3': 24.7}
    data = data.interpolate()
    data = data.bfill()
    # if one for the variables are all none
    for idx in missing_dict.keys():
        if pd.isnull(data[idx][0]):
            data[idx] = missing_dict[idx]

    # transfer the type of input
    data = data.values

    # input data
    x = data[:, :-1]
    delta_t = data[:, -1]

    # initialize parameters
    h_t = np.zeros(hidden_size)
    c_t = np.zeros(hidden_size)

    # model
    hidden_seq = []
    seq_size = len(x)
    for t in range(seq_size):
        x_t = x[t, :]
        delta_t_current = delta_t[t] + 0.1
        cs1_tb = np.tanh(c_t @ W_d + b_d)

        # Time decay function
        time_function = 1 / np.power(delta_t_current, 1)

        # T-LSTM Cell computation
        cs2_tb = cs1_tb * time_function
        c_t_b = c_t - cs1_tb
        cx_tb = c_t_b + cs2_tb

        # LSTM Gates computation
        i_t = sigmoid(x_t @ W_i + h_t @ U_i + b_i)
        f_t = sigmoid(x_t @ W_f + h_t @ U_f + b_f)
        g_t = np.tanh(x_t @ W_g + h_t @ U_g + b_g)
        o_t = sigmoid(x_t @ W_o + h_t @ U_o + b_o)

        # Update cell state and hidden state
        c_t = f_t * cx_tb + i_t * g_t
        h_t = o_t * np.tanh(c_t)
        hidden_seq.append(h_t)

    time_output = weight1 @ h_t + bias1
    mix_data = np.concatenate((time_output, [age, gender]))
    outputs = weight2 @ mix_data + bias2
    outputs = sigmoid(outputs)
    pred = outputs[1] / (outputs[0] + outputs[1])
    # add function3: calibration
    cal_pred = calibration_value(pred)
    # end add function3
    print(f"The risk is {cal_pred}")
