import pandas as pd
import numpy as np
import bisect


def sigmoid(x):
    return 1 / (1 + np.exp(-x))


def tanh(x):
    return np.tanh(x)


def relu(x):
    return np.maximum(0, x)

def calibration_value(value, percentiles = None):
    if percentiles is None:
        percentiles = [0.003692, 0.042890, 0.082533, 0.126830, 0.281165, 0.369144,
                       0.464698, 0.700450, 0.851368, 0.913875, 0.977074]
    n = len(percentiles) - 1
    if value <= percentiles[0]:
        return 0.0
    if value >= percentiles[-1]:
        return 1.0

    for i in range(n):
        if percentiles[i] <= value <= percentiles[i + 1]:
            frac = (value - percentiles[i]) / (percentiles[i + 1] - percentiles[i] + 1e-12)
            mapped_value = i / n + frac * (1.0 / n)
            break
    return mapped_value


# model parameters
W_d = [[ 2.9774544e-01,-2.6917300e-01,-1.7438985e-01, 8.5916197e-01, -8.9229815e-02, 5.3164631e-01, 7.7976510e-02, 6.0674906e-01, 3.9555211e-02,-1.8573472e-01, 5.8268666e-01,-1.6182362e-01, 2.4720962e-01,-1.6792549e-01, 1.4316791e-01,-5.3426266e-01],
 [ 5.0295860e-01, 9.2546239e-02,-1.3272473e-01,-3.3716840e-01, -1.9900563e-01,-9.7279072e-01,-5.8778512e-01,-1.5828542e-01, -4.9909126e-02,-2.9813671e-01,-4.7453710e-01,-4.0217322e-01, 7.3189355e-02,-1.4617981e-01, 4.3458331e-01, 1.5770674e-01],
 [ 1.8212350e-01, 9.3971372e-01,-2.0958191e-01,-1.5332238e-01, 6.6461474e-02,-2.0600797e-01, 2.7194224e-02,-4.7306094e-01, 3.8877714e-01,-1.2659299e-01, 9.0158023e-02, 8.2456666e-01, 2.5410610e-01, 5.5385011e-01, 2.7325982e-01,-4.6981603e-01],
 [ 2.5982234e-01, 1.3361733e-01,-3.6583328e-01, 2.0884842e-01, -3.3233568e-01, 1.7418574e+00, 3.3364605e-02, 2.0833420e-02, 3.6153612e-01,-9.6021451e-02, 2.5780895e-01,-1.9062269e-01, 2.3263896e-02, 1.0180024e-01, 1.3325834e-01,-7.9651737e-01],
 [-3.6923368e-02,-1.6594437e-01, 1.9554900e-01,-6.7893404e-01, -2.5754175e-01,-9.4859666e-01, 4.7353426e-01,-5.1084971e-01, 8.9058775e-01,-3.8058281e-01,-3.8652897e-01,-2.9734457e-01, -3.0652305e-01, 7.2606361e-01, 1.4119989e-01,-5.4758096e-01],
 [-2.5734299e-01, 2.0459935e-01, 3.5104525e-01,-5.3435838e-01, 2.6139283e-01, 3.3227902e-02, 3.0834006e-02, 2.0348725e-01, 8.2056612e-02,-1.0439316e-02,-2.4094641e-02, 1.0596447e-02, 2.7310476e-01,-4.9099419e-01,-2.8285682e-01,-1.3511607e-01],
 [ 4.6058080e-01, 5.1461041e-01, 5.9670713e-02,-8.7626421e-01, -2.5092176e-01,-3.6228403e-01,-1.0479649e-02,-5.2359396e-01, 3.4202221e-01,-4.6753556e-01,-7.3085386e-01, 1.2416128e-01, -3.5999843e-01, 5.1053452e-01, 4.6750990e-01, 7.2222191e-01],
 [-2.7283788e-01,-1.1051509e+00,-9.8893463e-05,-1.1042881e-01, 6.8130225e-02, 2.8467509e-01, 1.1360608e-01, 4.1502753e-01, -1.0468860e+00,-1.9643923e-02, 2.5366554e-01,-5.5937183e-01, -3.3893788e-01,-1.0921743e+00,-1.4338748e-01, 8.8104131e-03],
 [ 5.1467192e-01, 1.3953681e-01, 4.2952660e-01,-1.9654575e-01, -3.6937889e-01,-5.4257095e-01,-4.3684149e-01,-5.5007654e-01, 2.3193118e-01,-4.4979870e-01,-4.3112719e-01, 9.6003838e-02, 2.0836565e-01, 5.3199440e-01, 3.7857822e-01,-3.3269145e-02],
 [-8.6288624e-02,-4.7723889e-01, 1.5633491e-01, 8.7177181e-01, 3.9540136e-01,-1.1079353e-01, 4.2325008e-01, 1.4697808e-01, -3.2083237e-01,-2.8619519e-01, 5.6710249e-01,-5.7146275e-01, 2.0519578e-01,-1.8080587e-02, 1.1698809e-01,-4.0437481e-01],
 [ 4.8590106e-01, 8.1133449e-01, 2.9616013e-01,-1.0231389e+00, 1.7644906e-01,-7.3180461e-01,-4.4996879e-01, 1.5206550e-01, 4.9100482e-01,-4.4191858e-01,-4.0501937e-01, 1.5731506e-01, 2.9870686e-01, 2.1613179e-01,-1.8836334e-01, 5.7812858e-01],
 [-3.8883486e-01,-2.2288832e-01, 3.4907675e-01,-3.1111297e-01, 1.0207081e-01, 4.5690265e-01, 4.2287737e-01, 3.8906550e-01, -3.5090980e-01, 1.8076696e-01, 2.5079235e-01, 1.8858481e-02, -1.2982945e-01,-6.3110703e-01,-1.1768727e-01,-5.3519074e-02],
 [ 2.5702208e-01, 3.7181175e-01,-4.4121288e-02,-1.0330310e-01, 6.3186586e-03, 1.4548475e-01, 1.0311055e-01, 1.2156618e-01, -3.9313859e-01,-1.4472632e-01, 3.6438656e-01, 1.4650986e-01, -2.1639427e-02,-2.6108021e-01,-2.6491937e-01,-3.8777855e-01],
 [-7.1563847e-02, 5.2294350e-01, 9.1532126e-02, 3.1365022e-01, -3.8339430e-01, 1.4100023e-01,-2.4516593e-01, 1.1793984e+00, -2.3198245e-02,-1.6629043e-01,-3.4934443e-01,-2.3069502e-01, -2.7124488e-01, 7.2845846e-01,-2.1483839e-01,-2.0429881e-03],
 [-3.1075230e-01, 8.5417843e-01, 5.1925713e-01,-3.4655100e-01, -3.0283725e-01,-8.9204407e-01,-7.5789744e-01,-6.8573896e-03, 6.6445082e-01, 4.1709995e-01,-1.8522447e-02, 2.7276278e-01, 1.4522672e-02,-1.8245572e-01,-3.4893879e-01,-7.7915005e-03],
 [ 2.6544067e-01, 2.3955147e-01, 2.0576077e-02,-6.8097770e-01, -7.9495385e-02,-6.6264004e-01,-6.8496561e-01,-1.8801624e-01, 2.1042487e-01, 1.9793776e-01,-4.0713468e-01, 3.4270252e-03,-5.0987191e-02, 7.9903401e-02,-1.0917566e-01, 3.3814840e-02]]
b_d = [-0.67099166, -0.06227458, 0.0291882, 1.3242129, 0.00986608, -0.222943, 0.18903504,-3.3903139 , 2.2664876 ,-0.5335736 , 0.91175693,-0.45134923, -0.08887022, 0.12250462, 0.02224106, 0.19365361]
W_i = [[ 0.4046504 ,-1.1199147 , 0.44528186, 0.5798014 , 0.35466352,-0.17380607, 0.4821216 ,-0.24630116, 0.561686  , 0.6799998 ,-0.00330626,-0.08832012, -0.13092588,-0.4830728 , 0.06477371,-0.15126696],
 [ 0.40814555, 0.32725808, 0.68240815,-0.14928861,-0.5816961 , 0.43278587, 0.4080633 ,-0.5234138 , 0.3715543 ,-0.17898503, 0.02395099,-0.4161424 , -0.26902646,-0.17058654,-0.8241475 , 0.90392584],
 [ 0.57226956, 0.08998029, 0.03041672,-0.3463808 ,-0.5967366 ,-0.428662  , 0.32900774,-0.28698665, 0.13590467, 0.11622601,-0.10469095,-0.32596913, 0.00347399,-0.17110126,-0.4622347 , 0.25298753],
 [-0.29981354, 1.6713182 ,-0.13562131, 0.8463942 ,-0.24933653,-0.7291623 , 0.63666475, 0.24023052, 0.05275862, 0.30574733, 0.5626465 ,-0.04407086, 0.33760875, 0.45089793,-0.3178064 , 0.6954176 ],
 [-0.25163773, 1.2197948 , 0.54595727, 1.1182699 ,-0.37677363,-1.2567191 , -0.17930515,-0.5155696 , 0.1913072 ,-0.00526304, 0.41915426,-0.07928268, -0.42362708,-0.46649608,-0.06006225, 0.04647513],
 [ 0.02966995, 0.03314644,-0.07172045,-0.03090813,-0.118258  , 0.3919344 , -0.13298781,-0.4672999 , 0.05439257,-0.15562567, 0.57536465,-0.37837014, -0.3944981 , 0.13368268,-0.17862496, 0.61704564]]
U_i = [[ 2.57422835e-01,-1.37963176e-01,-4.68344182e-01, 3.50029133e-02, 3.47316086e-01,-3.81232619e-01,-3.81012410e-01, 4.13000703e-01, -5.77387571e-01,-4.63265955e-01,-4.57528412e-01, 1.61070153e-01, 2.01812178e-01, 1.55857712e-01, 4.04803365e-01,-8.81525099e-01],
 [-3.35744500e-01,-4.66312313e+00, 4.29237694e-01,-8.61824274e-01,-1.47619277e-01, 9.58335459e-01,-3.57346356e-01,-2.09130272e-01,3.49366456e-01, 5.45483470e-01, 3.46183479e-01,-5.51953495e-01,2.80506223e-01,-4.24593806e-01,-3.73599708e-01,-1.18132167e-01],
 [ 9.75971743e-02, 8.58747005e-01,-3.37765068e-01, 1.40258216e-03,4.87687215e-02,-1.11522011e-01,-1.57515109e-01,-1.80562332e-01,9.04817283e-01, 1.40407532e-01, 8.35358351e-02,-2.14224800e-01,-3.52755070e-01, 5.45822456e-02,-5.22755921e-01, 3.46811205e-01],
 [-4.31066602e-02, 2.94361782e+00, 4.46288176e-02,-9.42549169e-01, 5.13038218e-01,-2.76739764e+00,-3.18677425e-01,-2.06983298e-01, 3.66949707e-01, 7.85313770e-02,-4.91925813e-02,-1.70740902e-01, 4.01576608e-01, 1.43419385e-01,-3.66601110e-01,-6.33717895e-01],
 [-1.80009335e-01, 1.52112275e-01,-2.91214734e-01,-1.90754950e-01, -4.03799444e-01,-1.36030346e-01,-4.26002979e-01, 2.56845385e-01, 4.32134330e-01,-6.91579878e-02,-1.36291876e-01,-3.58014643e-01, -1.57775968e-01, 9.14894119e-02, 6.84230700e-02,-1.89974591e-01],
 [-1.52923331e-01, 8.51842761e-01,-3.32156509e-01, 1.44450769e-01, -6.01416588e-01,-6.70001030e-01,-7.99157172e-02, 5.23787811e-02, 5.04045188e-01, 3.99570793e-01,-6.64994493e-02, 2.37130180e-01, 4.04906869e-01,-2.51995683e-01,-8.38123739e-01, 8.61950696e-01],
 [ 3.39314789e-01,-3.30625802e-01,-3.34733129e-02,-4.27006960e-01, -3.54483366e-01, 8.36295709e-02, 1.15196377e-01, 9.17904675e-02, -1.17850862e-01, 3.99514824e-01, 6.19112551e-02,-2.55514205e-01, -2.45144963e-02, 1.03985935e-01, 1.51564017e-01,-3.06178361e-01],
 [ 1.60149515e-01,-4.75167942e+00,-3.59494120e-01, 3.33515763e-01, 1.53897643e-01, 2.01631069e+00, 5.86253166e-01, 2.54161447e-01, -3.34042981e-02, 2.09990874e-01,-1.94419578e-01, 2.15244055e-01, -2.22617447e-01,-2.89335966e-01, 1.26628935e+00, 2.15948880e-01],
 [ 2.42724478e-01, 3.09387475e-01,-2.23731712e-01,-9.46931660e-01, -1.17636761e-02,-3.21374941e+00, 2.85968453e-01, -7.27411434e-02, 5.14168799e-01, 7.54773378e-01, 4.36594576e-01, 8.28628838e-02, 8.90954211e-02,-7.56738484e-02, 8.86434495e-01, 5.29574215e-01],
 [ 1.61689073e-01, 1.21157217e+00,-1.12219222e-01, 7.79359162e-01, 1.92017674e-01,-1.47922680e-01, 7.37123415e-02, 3.23221654e-01, 3.91838133e-01, 3.55315536e-01,-3.77078593e-01,-2.37375647e-01, -9.50516164e-02,-7.98666552e-02,-3.57120067e-01,-9.25135076e-01],
 [ 2.01659799e-01, 1.36390805e-01,-2.39036784e-01,-4.92097050e-01, 3.25327277e-01,-5.79315841e-01, 4.57109869e-01,-1.46984002e-02, 4.74563926e-01, 3.81519496e-01, 2.59523578e-02, 1.23156421e-01, 3.01365852e-01,-3.53490323e-01,-1.82879716e-01, 6.06554568e-01],
 [ 4.85214731e-03,-4.57884014e-01, 1.60476938e-01,-2.48507008e-01, 1.06528968e-01,-2.32283339e-01, 4.94995028e-01,-1.60856303e-02, -8.78672719e-01, 6.90100715e-02,-3.41492295e-01, 2.94279546e-01, -2.69187391e-01, 6.09299392e-02, 6.66892231e-01,-1.94428414e-01],
 [ 4.07476932e-01, 4.12746631e-02, 2.50785381e-01, 3.42333674e-01, 3.49575967e-01,-1.49354592e-01,-9.68461633e-02, 2.08685189e-01, -1.18155181e-01, 2.02763513e-01,-9.45993066e-02,-2.93691874e-01, 1.76254958e-01, 6.63886666e-02, 1.93057984e-01, 4.30192083e-01],
 [ 2.95632035e-01, 4.10478383e-01, 2.31760740e-02,-3.72482568e-01, -3.03770185e-01,-2.68976033e-01,-3.81591737e-01,-2.17046544e-01, -3.98617506e-01,-3.99502546e-01,-2.58748710e-01,-4.26878572e-01, -2.65788585e-01, 1.65111512e-01, 3.61114591e-01,-1.28802553e-01],
 [-6.32108301e-02, 3.28479946e-01,-1.81291625e-01,-5.42128086e-01, 1.58793837e-01, 2.47191582e-02, 6.30558878e-02, 3.82368535e-01, 4.44430679e-01, 3.68054867e-01,-1.91146746e-01,-1.50730163e-01, 1.62468385e-02, 1.31701648e-01, 3.04398946e-02, 9.15715218e-01],
 [-2.41230682e-01, 8.93868685e-01,-1.81210563e-01,-4.48479503e-01, -1.28151119e-01,-6.63156629e-01, 4.34147209e-01, 5.00521660e-02, 2.61128217e-01, 3.48027200e-01,-2.95847595e-01,-2.66240776e-01, -9.55244005e-02,-4.49757338e-01,-5.96212566e-01, 1.42124593e-01]]
b_i = [ 1.3184471e-01, 4.4891441e-01, 6.2183127e-02, 8.7821983e-02, -1.1547387e-01,-1.2142388e-01, 1.3679707e-01,-1.4238550e-04, 4.9406451e-01, 1.4032926e-01, 6.7617834e-02,-1.4626440e-01, -8.6823981e-03,-7.3359087e-02,-3.1374976e-01, 5.4421222e-01]
W_f = [[ 0.69906193, 0.56995565,-0.09259818,-1.6757777 ,-0.34761497, 0.40486205, 0.4644187 , 0.4089287 , 0.26605198,-0.8186633 , 0.02499745, 0.5845181 , -0.06503581, 0.2388303 ,-0.51722986,-0.77633256],
 [ 0.25425932,-0.06869041,-0.49551046,-0.3894012 ,-0.54229355,-0.05715239, -0.04459577, 0.09382679, 0.3347874 ,-0.06525856, 0.23651639,-0.14118195, -0.25142184,-0.06240649,-0.51232916,-0.34505987],
 [ 0.3987082 ,-0.24859473, 0.01910069,-0.2947082 ,-0.51370573,-0.3312814 , 0.4699444 , 0.30887416, 0.03852722,-0.71756065, 0.797798  ,-0.221511  , 0.44995502, 0.20906527, 0.0680065 , 0.31337488],
 [ 0.18795182,-0.26457718,-0.52731156, 0.70207614,-0.3898459 , 0.14819212, -0.2550122 , 0.6871882 , 0.25270566,-0.44857708, 0.62642217, 0.05204858, 0.27451476,-0.33142292,-0.09672473, 0.21326177],
 [ 0.7781165 , 0.405269  ,-0.8767425 , 0.7940355 ,-0.12762399,-0.0816481 , -0.16713485, 0.44789705, 0.44724622,-0.34068716, 0.11263563, 0.2251319 , -0.30965272, 0.70857763,-0.5441995 , 0.00423298],
 [-0.19425584, 0.19061282,-0.27243432,-0.11378204, 0.06072085, 0.4120351 , 0.42409277, 0.7671811 , 0.6194759 , 0.01633426, 0.10409416, 0.56301045, 0.34784964,-0.09702951,-0.36129603,-0.3938809 ]]
U_f = [[-1.41040936e-01,-8.55097950e-01, 4.28638190e-01,-1.61752760e-01, -3.74635130e-01,-4.82204594e-02,-3.33278060e-01, 2.84755498e-01, 2.18253180e-01,-9.94903147e-02, 7.57975876e-02, 2.21995905e-01, 1.79344147e-01,-7.17462003e-01,-1.35561407e-01,-1.58538193e-01],
 [ 9.46168900e-02, 1.23603606e+00, 3.99854109e-02, 2.90799528e-01, -1.62902817e-01, 4.55522925e-01, 4.43179011e-01,-3.15644324e-01, -3.84971440e-01,-5.89262962e-01, 5.78826308e-01,-3.22882652e-01, -4.58440036e-01, 6.29829586e-01, 2.06326753e-01, 8.70441616e-01],
 [-3.85858789e-02,-4.13830817e-01, 2.67369211e-01,-3.69917182e-03, 2.58089095e-01,-4.41583902e-01, 2.35643685e-01, 4.97000366e-01, -2.71973938e-01,-2.29076192e-01, 5.24373651e-01,-5.27857132e-02, -2.35152856e-01,-1.39374822e-01, 1.19737998e-01, 2.04395264e-01],
 [ 7.45664313e-02,-4.13864017e-01, 2.41570473e-01,-1.96999681e+00, 1.59884780e-03,-1.79299951e-01, 1.42477274e-01, 6.98394924e-02, -2.18091562e-01,-5.79208016e-01, 2.96664864e-01,-2.35984340e-01, -4.14378464e-01, 1.79796308e-01, 1.14305332e-01,-1.26943961e-01],
 [-3.01437587e-01, 3.28817070e-01, 2.83777326e-01,-2.17438489e-02, -2.58909851e-01,-2.37462327e-01,-2.36182779e-01,-2.94274539e-02, -2.96766579e-01, 1.95772126e-01, 3.53807479e-01,-1.03989869e-01, 6.64399043e-02,-4.07396853e-01, 1.12681337e-01, 3.87789816e-01],
 [-2.71182895e-01,-8.77264977e-01,-1.51050910e-01, 8.65891337e-01, -2.20950842e-01, 4.67139453e-01,-1.84223950e-01, 1.93464354e-01, 1.90072298e-01,-5.93413532e-01, 3.09991807e-01,-2.62051404e-01, -1.77694738e-01, 3.08659971e-01,-3.10754448e-01,-5.17376848e-02],
 [-8.68540406e-02, 1.71926871e-01,-3.86644602e-01, 2.49203265e-01, -1.34573311e-01,-3.29380304e-01, 6.32344261e-02, 2.09731817e-01, 3.74727935e-01,-2.64468431e-01,-2.13123620e-01, 8.33024085e-02, 1.17459565e-01, 1.66481346e-01, 2.37669915e-01,-9.82535109e-02],
 [-1.23674169e-01, 1.34921050e+00, 1.86047149e+00, 1.28791595e+00, 2.12412700e-01, 9.72260237e-01,-3.04670691e-01,-3.85770112e-01, -1.44305646e-01, 4.41420972e-01,-3.21831614e-01,-1.15801573e+00, 2.17621192e-01, 2.34479457e-02, 2.63796329e-01, 1.56858444e-01],
 [-1.12002268e-01,-1.38301989e-02,-4.77453142e-01, 2.47990601e-02, -2.92539626e-01,-4.13849145e-01, 9.44854170e-02,-4.74208355e-01, 1.24469616e-01,-4.08795536e-01, 1.24854207e-01,-3.18544000e-01, -1.51194945e-01,-3.10216874e-01, 6.00809492e-02, 7.00116992e-01],
 [ 1.49359360e-01, 2.58546948e-01, 2.92401224e-01,-4.20586795e-01, -4.05466586e-01, 7.26590931e-01,-2.67408043e-01, 2.41355613e-01, 2.89431602e-01, 4.68402743e-01, 4.51223016e-01, 4.65734541e-01, 4.18841727e-02,-3.53709161e-01, 3.86885881e-01,-5.51039353e-02],
 [ 9.46700631e-04, 6.43529356e-01, 3.39797139e-02,-2.13671565e-01, 2.56218929e-02,-7.98093498e-01, 2.53575742e-01, 3.09462935e-01, 1.37674585e-01,-4.15658683e-01, 2.58131325e-01, 2.69538332e-02, 2.59123236e-01, 2.52793282e-01, 2.61422634e-01,-2.32500687e-01],
 [ 4.16032195e-01, 1.34586245e-01,-2.83567250e-01,-3.02241236e-01, 2.72125334e-01, 3.50468338e-01, 1.11771993e-01,-2.98827022e-01, -3.84982198e-01, 1.19325183e-01,-2.94300050e-01,-6.06960095e-02, -6.78629279e-02, 2.91661412e-01, 3.33688051e-01, 1.21846393e-01],
 [-1.53760344e-01,-1.78070724e-01,-1.07227504e-01,-1.67362228e-01, 3.89374882e-01, 2.29388580e-01, 3.90999943e-01, 1.38288736e-03, 8.73260796e-02, 1.50153488e-01,-4.09869522e-01, 3.86665463e-02, -2.89641712e-02,-2.42770314e-01,-3.35995048e-01, 3.83335084e-01],
 [ 3.52067918e-01, 2.00653657e-01, 4.13211673e-01,-1.75695539e-01, -7.47911334e-02, 1.63946658e-01,-7.15864450e-02,-8.49737972e-02, -3.57911587e-01, 1.16333827e-01,-2.61681348e-01, 1.57678053e-02, 4.22176808e-01,-1.33287936e-01,-1.36482030e-01, 2.61241198e-01],
 [ 1.22913651e-01, 4.75102216e-01, 1.55038834e-01, 5.27047068e-02, -3.10978293e-01,-7.09217414e-02, 1.83018774e-01,-3.09066623e-01, -2.00114161e-01,-1.73434943e-01, 3.90625328e-01, 2.45460104e-02, -3.42029184e-01, 1.79815471e-01,-1.97110161e-01,-1.23504624e-01],
 [-9.96147692e-02, 3.36132437e-01,-7.02123940e-01,-6.29534543e-01, -3.55079681e-01,-2.85127193e-01,-1.24221012e-01,-1.64085090e-01, 3.59566867e-01,-2.02505082e-01, 6.08336985e-01,-3.24078709e-01, -3.14348280e-01, 4.88814823e-02, 3.40808958e-01, 4.44935381e-01]]
b_f = [ 0.2942414 , 0.20238684,-0.44989714,-0.37291536,-0.00155155,-0.02430209, 0.31166753, 0.47005656, 0.05203871,-0.4658909 , 0.37042925, 0.07045937, -0.00415331, 0.16047327,-0.02030227,-0.07398836]
W_g = [[-0.39057654, 0.16104981,-0.08627176,-0.08286973,-0.15493765, 1.1203462 , 0.16175473,-0.0910621 ,-0.04345816,-0.3480948 , 0.43720156, 0.20559159, 0.13947843,-0.20355436, 0.48541924, 0.03538828],
 [-0.203314  , 0.46477744, 0.7479676 , 0.5523867 , 0.5866346 , 0.07748877, 0.26523793, 0.4480521 ,-0.59302574, 0.12943609,-0.08587682, 0.09376758, 0.20862088,-0.107887  , 0.06671117, 0.34780586],
 [-0.08777153,-0.2502271 , 0.7293008 ,-0.24690832, 0.30305505, 0.32452273, -0.03138456,-0.49125722, 0.23277447,-0.09763934, 0.00385045, 0.1244992 , -0.2729994 ,-0.241355  ,-0.15757129,-0.10256363],
 [-0.21810403, 0.04844892, 0.38448542,-0.41917378, 0.0756571 , 0.1802072 , 0.07262594, 0.28842533,-0.3707549 , 0.438441  , 0.55041724, 0.2897256 , -0.486861  ,-0.19928628,-0.43144283,-0.22388692],
 [ 0.29087484, 0.12481034, 0.43943754,-0.25565657, 0.37739456,-0.25040796, 0.26106006,-0.22841373,-0.14725468,-0.4000361 , 0.2655937 , 0.49548557, 0.25194448,-0.27863267, 0.05498401, 0.05054696],
 [-0.4204363 , 0.6171099 , 0.2763238 , 0.1696747 , 0.14886305, 0.04309977, 0.08611077, 0.19307524, 0.03833982, 0.06395256, 0.795348  ,-0.07818308, -0.32324293,-0.24425495, 0.5979503 , 0.11932335]]
U_g = [[-5.87789714e-02,-3.41779441e-01,-3.39526355e-01,-3.63203973e-01, -5.45356035e-01, 1.00739084e-01, 3.70420486e-01, 4.13224190e-01, -3.13360244e-01, 2.33417377e-01,-4.20281112e-01, 2.58467287e-01, 3.12692851e-01, 3.35095972e-01, 3.01806927e-01, 1.86236158e-01],
 [ 8.42800736e-03, 2.85581380e-01,-3.63749474e-01, 1.56830207e-01, -4.09525871e-01,-6.30921304e-01,-3.76885086e-01,-1.13221824e-01, -2.27052301e-01,-4.28442568e-01, 1.52553162e-02,-3.89619738e-01, 2.79931128e-02, 2.81016201e-01, 4.03596878e-01, 3.15565765e-01],
 [-2.24446654e-01,-2.81324118e-01, 3.48425180e-01, 3.12834412e-01, -9.34580043e-02, 3.39343339e-01, 3.66102368e-01, 2.62304246e-02, -2.61376977e-01, 4.91403669e-01, 3.50627661e-01, 2.86868840e-01, -2.92900324e-01, 2.51989812e-01,-2.97390819e-01, 4.67371881e-01],
 [-1.83467358e-01, 2.60923326e-01,-1.83702692e-01, 1.50752395e-01, 4.68502473e-03, 2.03777045e-01,-1.80467516e-01,-4.08148795e-01, -1.66364819e-01, 2.11063281e-01, 1.06295966e-01, 1.36104733e-01, -1.60338372e-01, 3.24824125e-01, 2.68199146e-01, 2.01425940e-01],
 [-2.21339494e-01,-3.53827327e-01, 4.81530204e-02,-1.66389972e-01, 3.87450904e-01,-3.52624685e-01, 1.93499655e-01, 4.31676418e-01, 2.16864794e-01, 1.47648126e-01,-5.16637981e-01, 4.16511923e-01, -7.40658939e-02,-4.04610723e-01, 4.26860213e-01,-1.76795781e-01],
 [-3.06346118e-02, 3.12399656e-01,-5.42010330e-02,-3.49349469e-01, 2.94155300e-01,-3.66170257e-01, 9.97408926e-02,-3.63170028e-01, 1.30818384e-02, 2.43462492e-02, 9.04519204e-03,-3.96622688e-01, 2.29330957e-01, 8.34140480e-02,-3.56092870e-01, 3.04391801e-01],
 [ 1.30605668e-01, 8.03512037e-02,-2.53982544e-01, 6.53002858e-02, 4.17225152e-01, 2.96996683e-01,-3.37260693e-01, 3.95263165e-01, 3.35627198e-02, 2.08264023e-01, 3.36347401e-01, 3.69147271e-01, -3.37548465e-01, 3.79173547e-01,-2.94091344e-01, 3.24612558e-02],
 [-3.02573502e-01,-2.57055342e-01, 1.01508740e-02,-3.49955224e-02, -6.85177222e-02,-4.47115332e-01, 4.27131802e-01, 2.51585394e-01, 2.42257565e-01,-5.57036251e-02, 1.12059927e+00,-1.99831128e-02, 3.44907120e-02, 8.91127288e-02,-3.77644271e-01,-3.54241878e-01],
 [ 5.30879498e-02,-3.69301625e-03, 1.33930445e-01, 7.86938518e-02, 2.52945632e-01, 5.97592629e-02,-1.43605173e-01, 3.46782833e-01, 3.41891021e-01,-2.10372552e-01,-1.59465834e-01,-3.50338668e-01, -2.37551048e-01,-1.68561578e-01,-2.25948635e-02,-4.70581204e-02],
 [-2.18779027e-01,-1.37558252e-01,-3.82503085e-02, 4.81371641e-01, -1.61018014e-01,-4.15800899e-01, 1.80002302e-01,-2.50114799e-02, 3.31498891e-01, 3.02127004e-01, 3.56698722e-01,-3.17120731e-01, 2.78369665e-01, 3.63401026e-01,-2.13834077e-01, 3.97949249e-01],
 [ 3.24604899e-01, 1.66319638e-01, 4.22062397e-01,-1.57520860e-01, -1.75422728e-01, 2.12240875e-01, 1.29092008e-01,-2.82999337e-01, 2.10140705e-01,-2.21833870e-01, 7.21668184e-01, 4.19176251e-01, 1.17594488e-01,-2.71684617e-01, 2.20353857e-01, 1.55057207e-01],
 [ 1.17744297e-01, 1.43067583e-01, 2.89155394e-01,-2.96535909e-01, -3.85664552e-01, 2.82669403e-02, 4.71815467e-02, 3.49171788e-01, -2.28128329e-01,-1.65452361e-02, 1.24875315e-01,-1.14990681e-01, 2.95079380e-01, 4.73636091e-02,-3.90096575e-01,-5.84798716e-02],
 [-1.96395889e-01, 4.20763493e-02,-5.03229797e-02,-4.29520100e-01, -7.89058805e-02,-4.14736569e-02,-1.27686113e-01, 3.97843570e-01, -9.44829881e-02, 2.78174788e-01, 1.07264906e-01,-3.65520358e-01, 1.01751953e-01, 3.58853012e-01,-2.83233881e-01,-2.79888570e-01],
 [ 4.23854083e-01, 3.47929984e-01,-2.41333604e-01, 2.60563225e-01, -5.53961992e-02,-4.26918894e-01, 3.25337350e-02, 1.39903814e-01, -1.29886866e-01, 1.50637954e-01,-3.70269537e-01, 3.00084680e-01, 3.69158179e-01, 2.38792092e-01, 7.33918846e-02, 1.42612249e-01],
 [-3.13305378e-01,-1.08757339e-01, 7.33457655e-02,-2.41112500e-01, -1.21812917e-01, 4.58694994e-01, 2.93862015e-01,-3.93257022e-01, 1.38380855e-01, 1.76743940e-01, 5.46532810e-01, 2.50407398e-01, 3.97905380e-01,-1.41763896e-01, 3.10970902e-01, 3.81290674e-01],
 [-4.08906043e-01,-2.00722054e-01, 3.29123020e-01, 3.65511477e-01, -2.08340213e-03, 2.33708754e-01,-6.28620386e-04, 1.09598845e-01, -2.32552052e-01, 3.80757600e-01, 5.81974566e-01,-3.00466925e-01, 3.91140999e-03, 1.20142102e-03, 1.48789883e-01, 4.61703300e-01]]
b_g = [ 0.0000000e+00, 1.6158032e-01, 2.9502714e-01, 2.1621399e-02, 3.3927390e-01, 2.6630726e-01, 2.4294247e-13, 1.3908317e-08, -3.5187127e-03, 1.4443797e-01, 2.6777369e-01,-1.4915003e-04, -2.6465446e-04, 3.2806535e-14, 9.9881217e-03, 8.3768040e-02]
W_o = [[-0.1892395 , 0.36088786, 0.8232728 ,-1.3460532 ,-0.6774631 , 0.4337077 , -0.52867454, 0.64848113,-1.3353955 , 0.3394767 , 0.5810873 ,-0.0878014 , -0.34019652,-0.6188788 , 0.382632  , 0.9096555 ],
 [-0.7621918 , 0.6960712 ,-0.0414354 , 0.06012834, 0.06007778, 0.7036617 , -0.48812246, 0.73206073, 0.7628215 ,-0.15902126, 0.7247411 ,-0.60236776, 0.04130153,-0.37263653, 0.3160286 , 0.406552  ],
 [-0.21373981,-0.38995388, 0.3516869 , 0.835006  ,-0.92430073, 0.2623463 , -0.11041842, 0.17285585, 0.34034884,-0.03679372, 0.55081123,-0.378913  , -0.31666404, 0.30686614, 0.300787  , 0.12881614],
 [-0.49454167, 0.59215075, 0.1888109 , 1.2303313 ,-0.22577661,-0.26859143, -0.4165042 , 0.317835  , 1.2737293 ,-0.12836736, 0.26311693, 0.11466412, -0.19975157,-0.5511601 , 0.44803014, 0.5858729 ],
 [ 0.12151574,-1.1316694 , 0.79787797, 2.0052114 ,-0.0590775 ,-0.26959443, 0.31511   ,-0.04930282, 0.27848402, 0.0137518 ,-0.1956558 ,-0.36569706, -0.24414061,-0.63693726, 0.03318261, 0.2751744 ],
 [ 0.05733318,-0.39945176, 0.7624393 , 0.33333996,-0.41198242, 0.3641291 , -0.44921562,-0.09336811,-0.20468816,-0.71243834,-0.06737673,-0.24539004, -0.4067532 ,-0.42382267, 0.09891155, 0.09517419]]
U_o = [[-7.62437433e-02,-3.05529255e-02,-4.98918235e-01, 1.70626923e-01, 5.05137265e-01,-5.48471868e-01,-7.34715909e-02,-2.27697447e-01, -6.40581906e-01, 1.15382589e-01,-1.43715143e-01, 5.29947102e-01, 1.02976941e-01, 3.61014009e-01,-2.03790352e-01,-6.43919706e-01],
 [-6.00998819e-01,-2.75780225e+00,-1.02695592e-01, 1.66413784e+00, -7.86134720e-01,-5.99280419e-03, 3.26103598e-01,-4.47019413e-02, 6.65322761e-04, 3.61723065e-01,-5.57092547e-01,-8.32082391e-01, 2.30062723e-01, 2.43925482e-01,-9.98117179e-02, 2.73094386e-01],
 [-6.22660339e-01,-8.86052370e-01, 1.90055594e-01,-6.91505671e-01, -2.35881642e-01,-2.70673066e-01, 2.61612445e-01, 4.66798812e-01, -5.46209216e-01,-1.22966960e-01, 2.15048403e-01,-9.58067656e-01, 2.27068335e-01, 3.89599860e-01, 1.38574988e-01,-1.49541363e-01],
 [-5.90782344e-01,-1.34794652e+00, 2.21093260e-02,-1.06215990e+00, 3.53917666e-02,-4.85385925e-01, 2.90769916e-02,-2.76022255e-01, 1.39789462e+00,-7.85511911e-01, 3.92139435e-01,-9.49316144e-01, 3.07662487e-01, 3.85760844e-01, 2.21600249e-01, 1.10179327e-01],
 [-1.59593493e-01, 1.18647143e-01,-4.54815835e-01, 4.66597527e-01, -1.04705967e-01, 1.42298579e-01,-1.99267385e-03,-1.83007538e-01, 5.19980490e-02, 2.95793772e-01,-1.67146847e-01,-3.92794222e-01, -9.69933122e-02,-1.57056108e-01, 9.66482908e-02, 2.78235734e-01],
 [-4.80682433e-01, 1.68477252e-01, 4.59089309e-01, 1.68821588e-01, -9.90457833e-01,-4.28395659e-01,-3.45112562e-01,-1.69207856e-01, 3.84718657e-01, 1.60399854e-01, 1.39284685e-01,-1.59836471e-01, 4.34178054e-01, 1.63494945e-02, 8.39484930e-02,-1.10902302e-01],
 [ 1.67362422e-01,-4.15187895e-01, 2.04157233e-01, 7.94127584e-02, 1.33065701e-01, 1.58542797e-01,-1.98798195e-01, 3.71569395e-01, 2.07035542e-01, 2.84443974e-01, 5.71916625e-02, 2.72061616e-01, 2.91417986e-01, 1.96256489e-01, 3.29855293e-01,-7.85389245e-02],
 [ 7.60255933e-01,-1.26804316e+00,-2.19463199e-01,-1.89794540e+00, -2.32986838e-01,-2.72599697e-01,-4.27291319e-02, 3.25793654e-01, 1.40484321e+00,-2.96295196e-01, 2.06658706e-01, 1.05053079e+00, -2.47241661e-01,-3.36910598e-02,-6.59876838e-02,-3.67945850e-01],
 [ 1.17293775e+00, 4.05656546e-01, 7.14705363e-02, 1.49195349e+00, -5.38693428e-01, 2.88070410e-01, 1.65193185e-01, 6.96623266e-01, -9.09193456e-01,-5.97909153e-01, 2.86500037e-01, 4.15235728e-01, -3.69822860e-01,-2.59110630e-01, 6.13215528e-02,-8.06884747e-03],
 [-3.46814215e-01, 3.73091607e-04,-6.41504377e-02, 9.06737745e-02, 1.23235606e-01,-4.41771358e-01,-3.17161769e-01,-2.56405950e-01, -8.74597967e-01, 2.20937476e-01, 3.78760338e-01, 1.02848172e-01, -9.07907635e-02,-1.28574222e-01,-9.50477365e-03, 1.31305024e-01],
 [-2.70579487e-01,-6.10590994e-01, 6.56713426e-01,-1.19728580e-01, -6.19639516e-01, 6.67894408e-02, 2.84444001e-02, 2.33368799e-01, -5.11212707e-01, 9.48156044e-02, 1.30429894e-01,-4.99099225e-01, -2.23220199e-01,-9.41263288e-02,-1.64850354e-01, 2.34800234e-01],
 [ 2.68536787e-02, 4.40083832e-01, 1.61762223e-01,-5.01210876e-02, -2.51691908e-01,-4.85982224e-02,-1.30151808e-01, 3.03375125e-01, -2.27743059e-01,-1.91494584e-01, 1.77568927e-01,-1.67139515e-01, -1.35904014e-01,-1.67144522e-01,-2.74522573e-01, 1.96806625e-01],
 [-3.87035787e-01, 2.09109828e-01,-3.89716566e-01,-5.26712686e-02, 2.58258283e-02, 3.07833284e-01,-1.56704485e-01, 1.24632984e-01, 6.87076673e-02, 2.54791409e-01, 2.57432759e-02, 1.62139267e-01, -2.61578977e-01,-3.00905287e-01, 3.85847956e-01,-3.15522075e-01],
 [-7.37202391e-02,-5.23395948e-02, 4.23498005e-01,-9.35826376e-02, -3.29654634e-01,-1.09768867e-01, 2.23357111e-01, 1.71598703e-01, 3.58353019e-01,-8.86449069e-02, 2.03968674e-01,-4.07437980e-01, 1.67549819e-01, 1.98953599e-01, 2.79330879e-01,-2.48307765e-01],
 [ 2.65663028e-01, 3.09068352e-01, 5.66621087e-02,-1.38587251e-01, -9.02419329e-01, 3.75060737e-01, 2.03248724e-01, 3.94857526e-01, 3.46077174e-01, 6.14740141e-02,-2.32818708e-01, 1.58229858e-01, -1.07882500e-01,-2.43908197e-01, 6.05607867e-01,-3.97289060e-02],
 [-2.03064263e-01,-1.01860690e+00, 4.83869344e-01,-4.99340355e-01, -3.46508920e-01,-2.18205795e-01, 2.48048574e-01,-5.50446734e-02, 1.48640871e-01,-6.34245396e-01, 3.51868659e-01,-7.59024322e-01, -1.79580804e-02,-1.15895577e-01, 4.65084791e-01, 3.75189215e-01]]
b_o = [-0.24270776,-0.5607847 , 0.5659976 , 0.52519315,-0.51246154, 0.32639885, -0.07557958, 0.4778576 , 0.24143046,-0.09048707, 0.19360839,-0.37721947, -0.01337556,-0.038199  , 0.2272697 , 0.29625225]
weight1 = [[-0.16387706,-0.38600197,-0.39856812, 1.9349947 ,-0.1329385 ,-2.0799565 , -0.20287599,-1.3184271 ,-1.1386722 , 0.1379556 , 0.0994456 ,-0.10597004, 0.2716075 ,-0.21985538, 0.29131815,-0.06367981],
 [ 0.14244196, 0.06588063,-0.15713656,-0.14772873, 0.05824409,-0.22066584, -0.23299924, 0.14376755,-0.22975098, 0.08511204,-0.6616692 ,-0.30531594, 0.17475781, 0.23892397,-0.36641055,-0.04655098],
 [-0.05727268, 0.8650449 ,-0.45337534, 1.2108094 ,-0.3547272 ,-2.3560047 , 0.15556867,-0.7140908 , 0.36653784, 0.0384433 , 0.07120805,-0.22497155, 0.11583838, 0.15550055, 0.20440082, 0.13843939],
 [-0.32028535, 1.5064112 , 1.548128  , 2.9664955 , 0.2499023 ,-0.93893796, 0.06379437, 0.2970261 , 1.118124  , 0.42115524, 0.3476495 ,-0.66510844, -0.1679323 , 0.10505456, 0.23113374, 0.83223754],
 [ 0.0666333 ,-0.14671   ,-0.11628257, 0.2047094 , 0.12075233,-0.04105801, 0.03680038, 0.04845015, 0.03124758,-0.08556938,-0.1306073 , 0.16614437, 0.03359315, 0.10463741,-0.0947186 , 0.09722058],
 [ 0.6001119 , 0.36842003,-0.30201203,-0.02263119, 0.04838832,-0.23195936, 0.23745656,-0.03375292, 0.10550218, 0.35401544,-0.30605495, 0.33580464, 0.21828651,-0.12953287,-0.28527614,-0.14217837]]
bias1 = [-0.18302606,-0.48747665,-0.35191256, 0.58308524,-0.25436363,-0.47227636]
weight2 = [[ 1.1421098 , 0.16381183, 1.52542   , 0.8691463 , 0.13611677, 0.13555814, -2.915e-05,-0.1811245 ]]
bias2 = [-2.4526906]
hidden_size = 16

if __name__ == '__main__':
    # raw demo data
    data = pd.read_csv('demo.csv')
    data = data.sort_values(by = 'date', ascending = True)
    data = data.groupby('date').agg(np.mean).reset_index()

    # extract the static variables
    age = data['age'][0]
    gender = data['gender'][0]
    del data['age']
    del data['gender']

    # calculate the time interval between each assessment
    interval_list = [0]
    for i in range(len(data) - 1):
        interval = int(str(data['date'][i + 1])[2:4]) * 12 + int(str(data['date'][i + 1])[4:6]) - \
                   (int(str(data['date'][i])[2:4]) * 12 + int(str(data['date'][i])[4:6]))
        interval_list.append(interval)
    data['interval'] = interval_list
    del data['date']

    # filling the missing data, different for different person
    # for female
    Cr = float(110) / 88.4
    if gender == 2:
        eGFR = 144 * np.power(Cr / 0.7, -1.209) * np.power(0.993, age)
    # for male
    else:
        eGFR = 141 * np.power(Cr / 0.9, -1.209) * np.power(0.993, age)
    missing_dict = {'egfr': eGFR,
                    'albumin': 39,
                    'ca': 2,
                    'ph': 1,
                    'uacr': float(np.exp(2.4738)),
                    'hco3': 24.7}
    data = data.interpolate()
    data = data.bfill()
    # if one for the variables are all none
    for idx in missing_dict.keys():
        if pd.isnull(data[idx][0]):
            data[idx] = missing_dict[idx]

    epsilon = 1e-6
    data['uacr'] = np.log(data['uacr'] + epsilon)

    # transfer the type of input
    data = data.values

    # input data
    x = data[:, :-1]
    delta_t = data[:, -1]

    # initialize parameters
    h_t = np.zeros(hidden_size)
    c_t = np.zeros(hidden_size)

    # model
    hidden_seq = []
    seq_size = len(x)
    for t in range(seq_size):
        x_t = x[t, :]
        delta_t_current = delta_t[t] + 0.1
        cs1_tb = np.tanh(c_t @ W_d + b_d)

        # Time decay function
        time_function = 1 / np.power(delta_t_current, 1)

        # T-LSTM Cell computation
        cs2_tb = cs1_tb * time_function
        c_t_b = c_t - cs1_tb
        cx_tb = c_t_b + cs2_tb

        # LSTM Gates computation
        i_t = sigmoid(x_t @ W_i + h_t @ U_i + b_i)
        f_t = sigmoid(x_t @ W_f + h_t @ U_f + b_f)
        g_t = np.tanh(x_t @ W_g + h_t @ U_g + b_g)
        o_t = sigmoid(x_t @ W_o + h_t @ U_o + b_o)

        # Update cell state and hidden state
        c_t = f_t * cx_tb + i_t * g_t
        h_t = o_t * np.tanh(c_t)
        hidden_seq.append(h_t)

    time_output = weight1 @ h_t + bias1
    time_output = relu(time_output)
    mix_data = np.concatenate((time_output, [age, gender]))
    outputs = weight2 @ mix_data + bias2
    outputs = sigmoid(outputs)
    print(f"The raw prediction is {outputs[0]:.4f}")
    cal_pred = calibration_value(outputs)
    print(f"The risk is {cal_pred[0]:.4f}", end="")
    if cal_pred[0] < 0.3:
        print(", which is low.")
    elif cal_pred[0] < 0.5:
        print(", which is moderate.")
    else:
        print(", which is high.")